<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ticket Details</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />

  <style>
    body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;background:#050814;color:#f7f7f7}
    header{padding:.75rem 1rem;background:#090f22;box-shadow:0 2px 6px rgba(0,0,0,.6);display:flex;align-items:center;justify-content:space-between}
    header a{color:#55d6ff;text-decoration:none;font-size:.9rem;margin-left:.75rem}
    .wrap{max-width:980px;margin:0 auto;padding:1rem}
    .card{background:#11172a;border-radius:12px;padding:1rem;margin-bottom:1rem;box-shadow:0 4px 12px rgba(0,0,0,.35)}
    .row{display:flex;gap:1rem;flex-wrap:wrap;align-items:center}
    .pill{display:inline-block;padding:.15rem .6rem;border-radius:999px;font-size:.75rem;font-weight:700;text-transform:uppercase}
    .pill.open{background:#2ecc71;color:#000}
    .pill.fixed{background:#3498db;color:#000}
    .muted{color:#a7a7a7;font-size:.9rem}
    .btn{border:0;border-radius:10px;padding:.55rem .85rem;cursor:pointer;font-weight:700}
    .btn.good{background:#2ecc71;color:#000}
    .btn.warn{background:#f1c40f;color:#000}
    .btn.primary{background:#55d6ff;color:#000}
    .btn.dark{background:#1e2640;color:#f7f7f7}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:.75rem}
    img.photo{width:100%;border-radius:10px;border:1px solid #1e2640}
    textarea,input{width:100%;box-sizing:border-box;padding:.6rem .7rem;border-radius:10px;border:1px solid #1e2640;background:#0b1022;color:#f7f7f7}
    label{font-size:.85rem;color:#cfcfcf;display:block;margin-bottom:.35rem}
    .comment{border-top:1px solid #1e2640;padding-top:.75rem;margin-top:.75rem}
    .comment:first-child{border-top:0;padding-top:0;margin-top:0}
    .error{color:#ff9aa2}.ok{color:#a7ffb4}
    #map { width: 100%; height: 340px; border-radius: 12px; border: 1px solid #1e2640; overflow:hidden; }
    .map-actions a { color:#55d6ff; text-decoration:none; font-weight:700; }
  </style>
</head>
<body>
  <header>
    <div><strong>Ticket Details</strong><span class="muted" id="ticketIdLabel"></span></div>
    <div>
      <a href="/dashboard">Dashboard</a>
      <a href="/new">+ New Ticket</a>
    </div>
  </header>

  <div class="wrap">
    <div id="statusMsg" class="muted">Loading ticket...</div>

    <div id="ticketCard" class="card" style="display:none;">
      <div class="row" style="justify-content:space-between;">
        <div>
          <h2 style="margin:0 0 .35rem 0;" id="locationFriendly"></h2>
          <div class="muted" id="metaLine"></div>
        </div>
        <span id="statusPill" class="pill"></span>
      </div>

      <div style="margin-top:.75rem;" class="muted" id="description"></div>

      <div style="margin-top:.9rem;" class="row">
        <button class="btn good" id="btnFix" style="display:none;">Mark Fixed</button>
        <button class="btn warn" id="btnReopen" style="display:none;">Mark Unresolved (Reopen)</button>
        <button class="btn dark" id="btnViewMap" style="display:none;">View Map</button>
      </div>
    </div>

    <div id="mapCard" class="card" style="display:none;">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <h3 style="margin:0;">Location</h3>
        <div class="map-actions">
          <a id="openInMaps" href="#" target="_blank" rel="noopener noreferrer" style="display:none;">Open in Google Maps</a>
        </div>
      </div>
      <div style="margin-top:.75rem;">
        <div id="map"></div>
        <div class="muted" style="margin-top:.5rem;" id="coordsLine"></div>
      </div>
    </div>

    <div id="photosCard" class="card" style="display:none;">
      <h3 style="margin:0 0 .75rem 0;">Photos</h3>
      <div id="photoGrid" class="grid"></div>
    </div>

    <div id="commentsCard" class="card" style="display:none;">
      <h3 style="margin:0 0 .75rem 0;">Comments / Updates</h3>

      <div class="row" style="margin-bottom:.75rem;">
        <div style="flex:1;min-width:240px;">
          <label for="commentAuthor">Your name</label>
          <input id="commentAuthor" placeholder="e.g. Samuel" />
        </div>
      </div>

      <div class="row" style="margin-bottom:.75rem;">
        <div style="flex:1;min-width:240px;">
          <label for="commentBody">Add an update</label>
          \1\n\n<label style="display:block;margin-top:0.75rem;">Attach photo (optional)</label>\n<input id="comment_photo" type="file" accept="image/*" />
        </div>
      </div>

      <div class="row" style="justify-content:flex-end;">
        <button class="btn primary" id="btnAddComment">Post Comment</button>
      </div>

      <div id="commentPostMsg" class="muted" style="margin-top:.75rem;"></div>
      <div style="margin-top:1rem;" id="commentList"></div>
    </div>
  </div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>

  <script>
    const qs=new URLSearchParams(location.search);
    const ticketId=qs.get('id');

    const statusMsg=document.getElementById('statusMsg');
    const ticketCard=document.getElementById('ticketCard');
    const photosCard=document.getElementById('photosCard');
    const commentsCard=document.getElementById('commentsCard');
    const mapCard=document.getElementById('mapCard');

    const ticketIdLabel=document.getElementById('ticketIdLabel');
    const locationFriendly=document.getElementById('locationFriendly');
    const metaLine=document.getElementById('metaLine');
    const descriptionEl=document.getElementById('description');
    const statusPill=document.getElementById('statusPill');

    const btnFix=document.getElementById('btnFix');
    const btnReopen=document.getElementById('btnReopen');
    const btnViewMap=document.getElementById('btnViewMap');

    const photoGrid=document.getElementById('photoGrid');

    const commentAuthor=document.getElementById('commentAuthor');
    const commentBody=document.getElementById('commentBody');
    const btnAddComment=document.getElementById('btnAddComment');
    const commentList=document.getElementById('commentList');
    const commentPostMsg=document.getElementById('commentPostMsg');

    const openInMaps=document.getElementById('openInMaps');
    const coordsLine=document.getElementById('coordsLine');

    const savedName=localStorage.getItem('ticket_comment_author');
    if(savedName) commentAuthor.value=savedName;

    function esc(s){return (s??'').toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');}

    function setPill(status){
      status=(status||'open').toLowerCase();
      statusPill.className='pill '+status;
      statusPill.textContent=status;
      btnFix.style.display=status==='open'?'inline-block':'none';
      btnReopen.style.display=status==='fixed'?'inline-block':'none';
    }

    async function fetchJson(url,opts){
      const res=await fetch(url,opts);
      const ct=res.headers.get('content-type')||'';
      const isJson=ct.includes('application/json');
      if(!res.ok){
        let details='';
        try{details=isJson?(await res.json()).error:await res.text();}catch{}
        throw new Error('HTTP '+res.status+': '+(details||res.statusText));
      }
      if(!isJson) throw new Error('Expected JSON but got '+ct);
      return await res.json();
    }

    let map=null;
    let marker=null;

    function initOrUpdateMap(lat, lon, title){
      if(!map){
        map = L.map('map', { zoomControl: true }).setView([lat, lon], 18);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
      } else {
        map.setView([lat, lon], 18);
      }

      if(marker){
        marker.setLatLng([lat, lon]);
      } else {
        marker = L.marker([lat, lon]).addTo(map);
      }
      marker.bindPopup(title || 'Ticket location').openPopup();

      // Leaflet needs a resize after showing hidden container
      setTimeout(()=>{ try{ map.invalidateSize(); }catch{} }, 150);
    }

    async function loadTicket(){
      if(!ticketId){statusMsg.innerHTML='<span class="error">Missing ticket id.</span>';return;}
      ticketIdLabel.textContent=' (#'+ticketId+')';
      statusMsg.textContent='Loading ticket...';

      try{
        const data=await fetchJson('/.netlify/functions/getTicket?id='+encodeURIComponent(ticketId));
        const t=data.ticket;

        locationFriendly.textContent=t.location_friendly||'(no location)';
        const created=t.created_at?new Date(t.created_at).toLocaleString():'';
        metaLine.textContent='Reported by '+(t.tech_name||'Unknown')+(created?' on '+created:'');
        descriptionEl.textContent=t.description||'';
        setPill(t.status);

        ticketCard.style.display='block';

        // Map
        const hasCoords = (t.lat != null && t.lon != null);
        if(hasCoords){
          btnViewMap.style.display='inline-block';
          mapCard.style.display='none'; // starts hidden until click
          const gmaps = `https://www.google.com/maps?q=${encodeURIComponent(t.lat + ',' + t.lon)}`;
          openInMaps.href = gmaps;
          openInMaps.style.display = 'inline-block';
          coordsLine.textContent = `GPS: ${t.lat.toFixed(6)}, ${t.lon.toFixed(6)}`;

          btnViewMap.onclick = () => {
            mapCard.style.display = 'block';
            // Scroll into view
            mapCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
            initOrUpdateMap(t.lat, t.lon, `Ticket #${t.id} â€“ ${t.location_friendly || ''}`);
          };
        } else {
          btnViewMap.style.display='none';
          mapCard.style.display='none';
        }

        // Photos
        photoGrid.innerHTML='';
        const photos=data.photos||[];
        if(photos.length){
          for(const p of photos){
            const url=p.photo_url||p.url||p.image_url;
            if(!url) continue;
            const a=document.createElement('a');
            a.href=url; a.target='_blank'; a.rel='noopener noreferrer';
            const img=document.createElement('img');
            img.className='photo'; img.src=url; img.alt='Ticket photo';
            a.appendChild(img); photoGrid.appendChild(a);
          }
          photosCard.style.display='block';
        } else {
          photosCard.style.display='none';
        }

        renderComments(data.comments||[]);
        commentsCard.style.display='block';
        statusMsg.textContent='';
      }catch(err){
        console.error(err);
        statusMsg.innerHTML='<span class="error">Network error loading ticket. '+esc(err.message)+'</span>';
        ticketCard.style.display='none'; photosCard.style.display='none'; commentsCard.style.display='none'; mapCard.style.display='none';
      }
    }

    function renderComments(comments){
      if(!comments.length){commentList.innerHTML='<div class="muted">No comments yet.</div>';return;}
      commentList.innerHTML=comments.map(c=>{
        const when=c.created_at?new Date(c.created_at).toLocaleString():'';
        return '<div class="comment"><div><strong>'+esc(c.author||'Unknown')+'</strong> <span class="muted">'+esc(when)+'</span></div><div style="margin-top:.25rem;">'+esc(c.body||'')+'</div></div>';
      }).join('');
    }

    async function updateStatus(newStatus){
      try{
        statusMsg.textContent='Updating status...';
        await fetchJson('/.netlify/functions/updateTicketStatus',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:ticketId,status:newStatus})});
        await loadTicket();
      }catch(err){
        statusMsg.innerHTML='<span class="error">Failed to update status. '+esc(err.message)+'</span>';
      }
    }

    btnFix.addEventListener('click',()=>updateStatus('fixed'));
    btnReopen.addEventListener('click',()=>updateStatus('open'));

    btnAddComment.addEventListener('click', async () => {
      const author = (document.getElementById('comment_author').value || '').trim();
      const comment = (document.getElementById('comment_body').value || '').trim();
      const file = document.getElementById('comment_photo') ? document.getElementById('comment_photo').files[0] : null;

      if (!author || !comment) {
        alert('Please enter your name and an update.');
        return;
      }

      btnAddComment.disabled = true;

      try {
        let photo_path = null;

        if (file) {
          // upload comment photo
          const arrayBuffer = await file.arrayBuffer();
          const bytes = new Uint8Array(arrayBuffer);
          let binary = '';
          for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);
          const base64 = btoa(binary);

          const up = await fetchJson('/.netlify/functions/uploadPhoto', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ base64, contentType: file.type || 'image/jpeg' })
          });
          photo_path = up.path || up.file || null;
        }

        await fetchJson('/.netlify/functions/addComment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ticket_id: ticketId, author, comment, photo_path })
        });

        document.getElementById('comment_body').value = '';
        if (document.getElementById('comment_photo')) document.getElementById('comment_photo').value = '';

        await loadTicket();
      } catch (e) {
        console.error(e);
        alert('Could not post comment: ' + (e.message || e));
      } finally {
        btnAddComment.disabled = false;
      }
    });

    loadTicket();
  </script>

</body>
</html>
