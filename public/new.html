<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>New Ticket</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin:0; font-family: system-ui,-apple-system,BlinkMacSystemFont,sans-serif; background:#050814; color:#f7f7f7; }
    header { padding:0.75rem 1rem; background:#090f22; box-shadow:0 2px 6px rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:space-between;}
    header a { color:#55d6ff; text-decoration:none; font-size:0.9rem; }
    .wrap { max-width: 720px; margin:0 auto; padding:1rem; }
    .card { background:#11172a; border-radius:12px; padding: 1rem; box-shadow:0 4px 12px rgba(0,0,0,0.35); }
    label { display:block; color:#cfcfcf; font-size:0.9rem; margin:0.75rem 0 0.35rem; }
    input, textarea { width:100%; box-sizing:border-box; padding:0.65rem 0.75rem; border-radius:10px; border:1px solid #1e2640; background:#0b1022; color:#f7f7f7; }
    textarea { min-height: 110px; resize: vertical; }
    .btn { margin-top: 1rem; width:100%; border:0; border-radius:14px; padding:0.9rem 1rem; font-weight:800; font-size:1.05rem; cursor:pointer; background:#2ecc71; color:#000; }
    .muted { color:#a7a7a7; font-size:0.9rem; margin-top:0.5rem; }
    .error { color:#ff9aa2; white-space:pre-wrap; }
    .ok { color:#a7ffb4; }
  </style>
</head>
<body>
  <header>
    <strong>Create Ticket</strong>
    <div><a href="/Dashboard">Dashboard</a></div>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="muted">Use this when you <strong>cannot</strong> restore a lights issue in the park. Always try to fix it before creating a ticket.</div>

      <label>Your Name</label>
      <input id="tech_name" placeholder="e.g. Adam" />

      <label>Friendly Location Name</label>
      <input id="location_friendly" placeholder='e.g. "Main Gate Tree"' />

      <label>Description of Issue</label>
      <textarea id="description" placeholder="What's wrong, what you already tried, etc."></textarea>

      <label>Photo of Issue (required)</label>
      <input id="photo" type="file" accept="image/*" />

      <button id="submitBtn" class="btn">Submit Ticket</button>
      <div id="msg" class="muted"></div>
    </div>
  </div>

  <script>
    const msg = document.getElementById('msg');
    const submitBtn = document.getElementById('submitBtn');

    function setMsg(text, cls='muted') {
      msg.className = cls;
      msg.textContent = text;
    }

    async function getCoordsSafe(timeoutMs=6000) {
      if (!navigator.geolocation) return null;
      return await new Promise((resolve) => {
        let done=false;
        const timer=setTimeout(()=>{ if(done) return; done=true; resolve(null); }, timeoutMs);
        navigator.geolocation.getCurrentPosition(
          (pos)=>{ if(done) return; done=true; clearTimeout(timer); resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }); },
          ()=>{ if(done) return; done=true; clearTimeout(timer); resolve(null); },
          { enableHighAccuracy:true, timeout: timeoutMs, maximumAge: 60000 }
        );
      });
    }

    async function compressImage(file, maxDim=1600, quality=0.78) {
      const bitmap = await createImageBitmap(file);
      const width = bitmap.width;
      const height = bitmap.height;
      const scale = Math.min(1, maxDim / Math.max(width, height));
      const w = Math.round(width * scale);
      const h = Math.round(height * scale);

      const canvas = document.createElement('canvas');
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(bitmap, 0, 0, w, h);

      return await new Promise((resolve) => {
        canvas.toBlob((blob) => resolve(blob), 'image/jpeg', quality);
      });
    }

    async function fetchJsonOrText(url, opts) {
      const res = await fetch(url, opts);
      const text = await res.text();
      let json = null;
      try { json = JSON.parse(text); } catch {}
      if (!res.ok) {
        const err = (json && (json.error || json.message)) ? (json.error || json.message) : text;
        throw new Error(err || (res.status + ' ' + res.statusText));
      }
      return json || {};
    }

    
    // --- Duplicate modal helpers ---
    const dupModal = document.getElementById('dupModal');
    const dupList = document.getElementById('dupList');
    const dupMsg = document.getElementById('dupMsg');
    const dupClose = document.getElementById('dupClose');
    const dupCreateNew = document.getElementById('dupCreateNew');
    const dupMergeFirst = document.getElementById('dupMergeFirst');

    let pendingCreatePayload = null; // {tech_name, location_friendly, description, lat, lon, photo_url}
    let duplicateMatches = [];
    let selectedDuplicateId = null;

    function showDupModal(matches, radius_m) {
      duplicateMatches = matches || [];
      selectedDuplicateId = duplicateMatches.length ? duplicateMatches[0].id : null;
      dupMsg.textContent = '';
      dupList.innerHTML = '';

      duplicateMatches.forEach((t, idx) => {
        const card = document.createElement('div');
        card.style.background = '#11172a';
        card.style.border = (t.id === selectedDuplicateId) ? '2px solid #55d6ff' : '1px solid #1e2640';
        card.style.borderRadius = '12px';
        card.style.padding = '0.75rem';
        card.style.cursor = 'pointer';

        const dist = (typeof t.distance_m === 'number') ? `${Math.round(t.distance_m)}m` : '';
        const photo = t.photo_url ? `
          <div style="margin-top:0.5rem;">
            <img src="${t.photo_url}" alt="ticket photo" style="max-width:100%;border-radius:10px;border:1px solid #1e2640;" />
          </div>` : '';

        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:0.75rem;align-items:baseline;">
            <div style="font-weight:900;">Ticket #${t.id} • ${t.location_friendly || ''}</div>
            <div style="color:#a7a7a7;font-size:0.85rem;">${dist}</div>
          </div>
          <div style="margin-top:0.25rem;color:#cfcfcf;font-size:0.92rem;">${t.description ? `"${t.description}"` : ''}</div>
          <div style="margin-top:0.35rem;">
            <a href="/ticket.html?id=${t.id}" target="_blank" style="color:#55d6ff;text-decoration:none;font-weight:800;">Open ticket</a>
          </div>
          ${photo}
        `;

        card.addEventListener('click', () => {
          selectedDuplicateId = t.id;
          // re-render borders
          [...dupList.children].forEach((child) => child.style.border = '1px solid #1e2640');
          card.style.border = '2px solid #55d6ff';
        });

        dupList.appendChild(card);
      });

      const topLine = document.createElement('div');
      topLine.className = 'muted';
      topLine.style.marginBottom = '0.5rem';
      topLine.textContent = `Within ~${radius_m || 25}m: ${duplicateMatches.length} open ticket(s) found.`;
      dupList.prepend(topLine);

      dupModal.style.display = 'flex';
    }

    function hideDupModal() {
      dupModal.style.display = 'none';
    }

    dupClose?.addEventListener('click', hideDupModal);

    async function createTicketFinal(force_create=false) {
      if (!pendingCreatePayload) throw new Error('Missing pending payload');
      const payload = Object.assign({}, pendingCreatePayload, { force_create: !!force_create });
      return await fetchJsonOrText('/.netlify/functions/createTicket', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload),
        cache: 'no-store'
      });
    }

    async function mergeIntoTicket(ticketId) {
      if (!pendingCreatePayload) throw new Error('Missing pending payload');
      const { tech_name, location_friendly, description, photo_url } = pendingCreatePayload;

      const body = `Possible duplicate reported at "${location_friendly}": ${description}`;
      return await fetchJsonOrText('/.netlify/functions/addComment', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          ticket_id: Number(ticketId),
          author: tech_name,
          body,
          photo_url
        }),
        cache: 'no-store'
      });
    }

    dupCreateNew?.addEventListener('click', async () => {
      try {
        dupCreateNew.disabled = true;
        dupMergeFirst.disabled = true;
        dupMsg.textContent = 'Creating new ticket...';
        const createRes = await createTicketFinal(true);
        const id = createRes.id || (createRes.ticket && createRes.ticket.id);
        hideDupModal();
        setMsg('Ticket created successfully.', 'ok');
        if (id) location.href = '/ticket.html?id=' + id;
      } catch (e) {
        console.error(e);
        dupMsg.textContent = 'Error: ' + (e.message || e);
      } finally {
        dupCreateNew.disabled = false;
        dupMergeFirst.disabled = false;
      }
    });

    dupMergeFirst?.addEventListener('click', async () => {
      try {
        if (!selectedDuplicateId) {
          dupMsg.textContent = 'Select a ticket to merge into.';
          return;
        }
        dupCreateNew.disabled = true;
        dupMergeFirst.disabled = true;
        dupMsg.textContent = `Merging into Ticket #${selectedDuplicateId}...`;
        await mergeIntoTicket(selectedDuplicateId);
        hideDupModal();
        setMsg(`Merged into Ticket #${selectedDuplicateId}.`, 'ok');
        location.href = '/ticket.html?id=' + selectedDuplicateId;
      } catch (e) {
        console.error(e);
        dupMsg.textContent = 'Error: ' + (e.message || e);
      } finally {
        dupCreateNew.disabled = false;
        dupMergeFirst.disabled = false;
      }
    });

    submitBtn.addEventListener('click', async () => {
      const tech_name = (document.getElementById('tech_name').value || '').trim();
      const location_friendly = (document.getElementById('location_friendly').value || '').trim();
      const description = (document.getElementById('description').value || '').trim();
      const file = document.getElementById('photo').files[0];

      if (!tech_name || !location_friendly || !description) {
        setMsg('Please fill in name, location, and description.', 'error');
        return;
      }
      if (!file) {
        setMsg('Photo is required.', 'error');
        return;
      }

      submitBtn.disabled = true;
      setMsg('Submitting...');

      try {
        const coords = await getCoordsSafe();
        const compressed = await compressImage(file);
        const photoBlob = compressed || file;

        // Upload photo first (required)
        const fd = new FormData();
        fd.append('file', photoBlob, 'ticket.jpg');

        const uploadRes = await fetchJsonOrText('/.netlify/functions/uploadPhoto', {
          method: 'POST',
          body: fd,
          cache: 'no-store'
        });

        const photo_url = uploadRes.publicUrl || uploadRes.public_url || uploadRes.url;
        if (!photo_url) throw new Error('Upload did not return publicUrl.');

        // Build payload (used for dry-run + create)
        pendingCreatePayload = {
          tech_name,
          location_friendly,
          description,
          lat: coords ? coords.lat : null,
          lon: coords ? coords.lon : null,
          photo_url
        };

        // Duplicate check (only checks OPEN tickets; server-enforced)
        const precheck = await fetchJsonOrText('/.netlify/functions/createTicket', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(Object.assign({}, pendingCreatePayload, { dry_run: true })),
          cache: 'no-store'
        });

        if (precheck && precheck.duplicate && Array.isArray(precheck.matches) && precheck.matches.length) {
          setMsg('Possible duplicate found. Review prompt.', 'muted');
          showDupModal(precheck.matches, precheck.radius_m);
          return; // stop here; modal will decide merge/new
        }

        // No duplicates → create ticket
        const createRes = await createTicketFinal(false);
        const id = createRes.id || (createRes.ticket && createRes.ticket.id);
        setMsg('Ticket created successfully.', 'ok');
        if (id) location.href = '/ticket.html?id=' + id;
      } catch (e) {
        console.error(e);
        setMsg('Could not submit ticket: ' + (e.message || e), 'error');
      } finally {
        submitBtn.disabled = false;
      }
    });
  </script>
    }
    });
  </script>

  <!-- Duplicate check modal -->
  <div id="dupModal" style="position:fixed;inset:0;background:rgba(0,0,0,0.72);display:none;align-items:center;justify-content:center;padding:1rem;z-index:9999;">
    <div style="width:100%;max-width:720px;background:#0b1022;border:1px solid #1e2640;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,0.6);padding:1rem;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:1rem;">
        <div style="font-weight:900;font-size:1.05rem;">Possible duplicate ticket nearby</div>
        <button id="dupClose" style="background:transparent;border:0;color:#55d6ff;font-weight:800;cursor:pointer;">Close</button>
      </div>
      <div class="muted" style="margin-top:0.35rem;">We found open ticket(s) near your GPS location. Review below before creating a new one.</div>
      <div id="dupList" style="margin-top:0.75rem;display:flex;flex-direction:column;gap:0.75rem;"></div>
      <div style="display:flex;gap:0.75rem;margin-top:1rem;flex-wrap:wrap;">
        <button id="dupCreateNew" class="btn" style="flex:1;background:#f1c40f;">Create new ticket anyway</button>
        <button id="dupMergeFirst" class="btn" style="flex:1;background:#2ecc71;">Merge into selected ticket</button>
      </div>
      <div id="dupMsg" class="muted" style="margin-top:0.5rem;"></div>
    </div>
  </div>

</body>
</html>
